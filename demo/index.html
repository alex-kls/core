<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script src="build/fin-hypergrid.js"></script>
    <script>
        'use strict';

        var HTTP_STATE_DONE = 4,
            HTTP_STATUS_OK = 200,
            LOCAL_STORAGE_COLUMNS_DEF = 'colDef';

        function get(url, callback) {
            var httpRequest = new XMLHttpRequest();
            httpRequest.open('GET', url, true);
            httpRequest.onreadystatechange = function() {
                if (
                    httpRequest.readyState === HTTP_STATE_DONE &&
                    httpRequest.status === HTTP_STATUS_OK
                ) {
                    callback(JSON.parse(httpRequest.responseText));
                }
            };
            httpRequest.send(null);
        }

        window.onload = function() {
            get('data/datadoc.json', function(result) {
                console.log('result', result);
                var loadingSpan = document.querySelector('span#loading');
                loadingSpan.style.visibility = "hidden";
                var div = document.querySelector('div#json-example');

                function getColDef() {
                    var colDef = localStorage.getItem(LOCAL_STORAGE_COLUMNS_DEF);
                    if (!colDef || colDef.length <= 2) {
                        colDef = "[{\"colId\":\"c0\",\"field\":\"c0\",\"originalField\":\"c0\",\"headerName\":\"Content provider\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\",\"pinned\":\"left\"},{\"colId\":\"c1\",\"field\":\"c1\",\"originalField\":\"c1\",\"headerName\":\"Title\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c2\",\"field\":\"c2\",\"originalField\":\"c2\",\"headerName\":\"Vendor ID\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c3\",\"field\":\"c3\",\"originalField\":\"c3\",\"headerName\":\"Apple ID\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"rigth\"},{\"colId\":\"c4\",\"field\":\"c4\",\"originalField\":\"c4\",\"headerName\":\"Apollo titles matched v apple ID\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c5\",\"field\":\"c5\",\"originalField\":\"c5\",\"headerName\":\"Eidr l1 from avail\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c6\",\"field\":\"c6\",\"originalField\":\"c6\",\"headerName\":\"Film type\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c7\",\"field\":\"c7\",\"originalField\":\"c7\",\"headerName\":\"Territory\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c8\",\"field\":\"c8\",\"originalField\":\"c8\",\"headerName\":\"Live vod hd\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c9\",\"field\":\"c9\",\"originalField\":\"c9\",\"headerName\":\"Live vod sd\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c10\",\"field\":\"c10\",\"originalField\":\"c10\",\"headerName\":\"Live est hd\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c11\",\"field\":\"c11\",\"originalField\":\"c11\",\"headerName\":\"Live est sd\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c12\",\"field\":\"c12\",\"originalField\":\"c12\",\"headerName\":\"Allow pre-Order\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c13\",\"field\":\"c13\",\"originalField\":\"c13\",\"headerName\":\"Pre-Order date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c14\",\"field\":\"c14\",\"originalField\":\"c14\",\"headerName\":\"Sd wholesale price tier\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c15\",\"field\":\"c15\",\"originalField\":\"c15\",\"headerName\":\"Sd wholesale price tier start date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c16\",\"field\":\"c16\",\"originalField\":\"c16\",\"headerName\":\"Sd wholesale price tier end date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c17\",\"field\":\"c17\",\"originalField\":\"c17\",\"headerName\":\"Hd wholesale price tier\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c18\",\"field\":\"c18\",\"originalField\":\"c18\",\"headerName\":\"Hd wholesale price tier start date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c19\",\"field\":\"c19\",\"originalField\":\"c19\",\"headerName\":\"Hd wholesale price tier end date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c20\",\"field\":\"c20\",\"originalField\":\"c20\",\"headerName\":\"Cleared for sale est\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c21\",\"field\":\"c21\",\"originalField\":\"c21\",\"headerName\":\"Enable est hd\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c22\",\"field\":\"c22\",\"originalField\":\"c22\",\"headerName\":\"Est start date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c23\",\"field\":\"c23\",\"originalField\":\"c23\",\"headerName\":\"Est end date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c24\",\"field\":\"c24\",\"originalField\":\"c24\",\"headerName\":\"Vod type\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c25\",\"field\":\"c25\",\"originalField\":\"c25\",\"headerName\":\"Cleared for vod\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c26\",\"field\":\"c26\",\"originalField\":\"c26\",\"headerName\":\"Enable vod hd\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c27\",\"field\":\"c27\",\"originalField\":\"c27\",\"headerName\":\"Avail for vod\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c28\",\"field\":\"c28\",\"originalField\":\"c28\",\"headerName\":\"Unavail for vod\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c29\",\"field\":\"c29\",\"originalField\":\"c29\",\"headerName\":\"Physical release date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c30\",\"field\":\"c30\",\"originalField\":\"c30\",\"headerName\":\"Hd physical release date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c31\",\"field\":\"c31\",\"originalField\":\"c31\",\"headerName\":\"Hd est early start date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c32\",\"field\":\"c32\",\"originalField\":\"c32\",\"headerName\":\"Genres\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c33\",\"field\":\"c33\",\"originalField\":\"c33\",\"headerName\":\"Rating\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c34\",\"field\":\"c34\",\"originalField\":\"c34\",\"headerName\":\"Rating reason\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c35\",\"field\":\"c35\",\"originalField\":\"c35\",\"headerName\":\"Production company\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c36\",\"field\":\"c36\",\"originalField\":\"c36\",\"headerName\":\"Copyright\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"c37\",\"field\":\"c37\",\"originalField\":\"c37\",\"headerName\":\"Custom page\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"}]";
                    }
                    return JSON.parse(colDef);
                }
                var colDef = getColDef();

                function prepareData(result) {
                    var res = [];
                    result.data.children.forEach(function(c) {
                        var forPush = {};
                        var keys = Object.keys(c.data);

                        keys.forEach(function(d) {
                            // return forPush[d] = c.data[keys[Math.floor(Math.random() * keys.length)]];
                            return forPush[d] = c.data[d];
                        });
                        res.push(forPush);
                    });
                    return res;
                }

                function prepareSchema(result) {
                    var res = [];
                    result.headers.children.forEach(function(h) {
                        res.push({ header: h.key, name: h.key });
                    });
                    return res;
                }

                var options = {
                    schema: prepareSchema(result),
                    data: [],
                    api: {
                        onScrollEndLimitTrigger: 200
                    },
                    onColumnResized: function(column) {
                        console.log('onColumnResized', column);
                        var singleColDef = colDef.find(function(cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            singleColDef.width = column.getWidth();
                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        } else {
                            console.error('no coldDef', colDef, column);
                        }
                    },
                    onColumnsMoved: function(columns, toIndex) {
                        console.log('onColumnsMoved', columns, toIndex);
                        columns.forEach(function(column) {
                            var colDefsLocal = getColDef();
                            var singleColDef = colDefsLocal.find(function(cd) {
                                return cd.colId === column.name;
                            });

                            if (singleColDef) {
                                colDefsLocal.splice(toIndex, 0, colDefsLocal.splice(colDefsLocal.indexOf(singleColDef), 1)[0]);
                                localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDefsLocal));
                            } else {
                                console.error('no coldDef', colDef, column);
                            }
                        });
                    },
                    onUpdateColumnName: function(column, renameTo) {
                        console.log('onUpdateColumnName', column, renameTo);
                        var singleColDef = colDef.find(function (cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            singleColDef.headerName = renameTo;
                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        } else {
                            console.log('column', column);
                            var colDefLength = colDef.length + 1;
                            colDef.push({
                                colId:"c" + colDefLength,
                                field:"c" + colDefLength,
                                originalField:"c" + colDefLength,
                                headerName:renameTo,
                                suppressSorting:false,
                                minWidth:10,
                                maxWidth:2000,
                                suppressMenu:0,
                                suppressMovable:false,
                                suppressSizeToFit:false,
                                sort:null,
                                sortedAt:null,
                                columnGroupShow:"open",
                                pinned:"left"
                            });

                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        }
                    },
                    onRemoveColumn: function(column) {
                        var singleColDef = colDef.find(function (cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            colDef.splice(colDef.indexOf(singleColDef), 1);
                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        } else {
                            console.error('no coldDef', colDef, column);
                        }
                    }
                };
                window.grid = window.grid || new fin.Hypergrid(div, options);

                (function appendData() {
                    window.grid.api.clearFocusedCell();
                    window.grid.api.clearRangeSelection();
                    window.grid.api.destroy();
                    window.grid.api.setColumnDefs(getColDef());
                    window.grid.api.setRowData(prepareData(result));
                    window.grid.api.sizeColumnsToFit();

                    window.grid.api.attachLinkToDataCell(1, 1, 'https://google.com');
                    window.grid.api.attachLinkToDataCell(1, 2, 'https://google.com');
                    // setTimeout(appendData, 5000);
                })();
            });
        };
    </script>
    <style>
        body * {
            box-sizing: border-box;
        }

        /* for beautiful canvas drawing */

        canvas {
            image-rendering: auto;
            /*image-rendering: optimizeSpeed;*/
            /*image-rendering: -moz-crisp-edges;*/
            /*image-rendering: -webkit-optimize-contrast;*/
            /*image-rendering: -o-crisp-edges;*/
            /*image-rendering: pixelated;*/
            /*-ms-interpolation-mode: nearest-neighbor;*/
        }
    </style>
</head>
<body>
<p> Fin-HyperGrid example using AJAX. <span id="loading">Loading... </span></p>
<div id="json-example" style="position:relative; width:100%; height: 100%"></div>
</body>
</html>
