<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script src="build/fin-hypergrid.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <script>
        'use strict';

        var HTTP_STATE_DONE = 4,
            HTTP_STATUS_OK = 200,
            LOCAL_STORAGE_COLUMNS_DEF = 'colDef';

        function get(url, callback) {
            var httpRequest = new XMLHttpRequest();
            httpRequest.open('GET', url, true);
            httpRequest.onreadystatechange = function() {
                if (
                    httpRequest.readyState === HTTP_STATE_DONE &&
                    httpRequest.status === HTTP_STATUS_OK
                ) {
                    callback(JSON.parse(httpRequest.responseText));
                }
            };
            httpRequest.send(null);
        }

        window.onload = function() {
            get('data/datadoc.json', function(result) {
                console.log('result', result);
                var loadingSpan = document.querySelector('span#loading');
                loadingSpan.style.visibility = "hidden";
                var div = document.querySelector('div#json-example');

                function getColDef() {
                    var colDef = undefined;//localStorage.getItem(LOCAL_STORAGE_COLUMNS_DEF);
                    if (!colDef || colDef.length <= 2) {
                        colDef = "[{\"colId\":\"36\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"title_id\\\",\\\"index\\\":0}\",\"headerName\":\"title_id\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":407,\"firstError\":{\"rowNumber\":0,\"description\":\"Some values in this column could not be converted to a number, for example: \\\"083AF\\\". According to your Ingest Settings, these values will be made NULL.\",\"type\":\"ERROR\"},\"colType\":\"DECIMAL\",\"colTypeSign\":\"123\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"right\"},{\"colId\":\"38\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"territory_value\\\",\\\"index\\\":1}\",\"headerName\":\"territory_value\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"40\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"territory_id\\\",\\\"index\\\":2}\",\"headerName\":\"territory_id\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"42\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"file_names\\\",\\\"index\\\":3}\",\"headerName\":\"file_names\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"44\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"vendor_ids\\\",\\\"index\\\":4}\",\"headerName\":\"vendor_ids\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"46\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"provider_id\\\",\\\"index\\\":5}\",\"headerName\":\"provider_id\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"48\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"platform_type_id\\\",\\\"index\\\":6}\",\"headerName\":\"platform_type_id\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"50\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"territory_id\\\",\\\"index\\\":7}\",\"headerName\":\"territory_id\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"52\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"id_type\\\",\\\"index\\\":8}\",\"headerName\":\"id_type\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"54\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"id_value\\\",\\\"index\\\":9}\",\"headerName\":\"id_value\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"},{\"colId\":\"56\",\"field\":\"{\\\"type\\\":\\\"i\\\",\\\"columnName\\\":\\\"file_name\\\",\\\"index\\\":10}\",\"headerName\":\"file_name\",\"hide\":false,\"suppressSorting\":true,\"errorCount\":0,\"firstError\":null,\"colType\":\"STRING\",\"colTypeSign\":\"ABC\",\"isList\":false,\"suppressSizeToFit\":true,\"minWidth\":10,\"maxWidth\":2000,\"halign\":\"left\"}]";
                    }
                    return JSON.parse(colDef);
                }

                var colDef = getColDef();

                function prepareData(result) {
                    var res = [];
                    (result.data.children || result.data).forEach(function(c) {
                        var forPush = {};
                        var data = c.data || c;
                        var keys = Object.keys(data);

                        keys.forEach(function(d) {
                            // return forPush[d] = c.data[keys[Math.floor(Math.random() * keys.length)]];
                            return forPush[d] = data[d];
                        });
                        res.push(forPush);
                    });
                    return res;
                }

                var options = {
                    data: [],
                    api: {
                        onScrollEndLimitTrigger: 200
                    },
                    theme: {
                        showAdditionalInfo: true
                    },
                    onColumnResized: function(column) {
                        console.log('onColumnResized', column);
                        localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));

                        var singleColDef = colDef.find(function(cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            singleColDef.width = column.getWidth();

                        } else {
                            console.error('no coldDef', colDef, column);
                        }
                    },
                    onColumnsMoved: function(columns, toIndex) {
                        console.log('onColumnsMoved', columns, toIndex);
                        localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(window.grid.columnDefs));
                    },
                    onUpdateColumnName: function(column, renameTo) {
                        console.log('onUpdateColumnName', column, renameTo);
                        var singleColDef = colDef.find(function(cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            singleColDef.headerName = renameTo;
                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        } else {
                            console.log('column', column);
                            var colDefLength = colDef.length + 1;
                            colDef.push({
                                colId: "c" + colDefLength,
                                field: "c" + colDefLength,
                                originalField: "c" + colDefLength,
                                headerName: renameTo,
                                suppressSorting: false,
                                minWidth: 10,
                                maxWidth: 2000,
                                suppressMenu: 0,
                                suppressMovable: false,
                                suppressSizeToFit: false,
                                sort: null,
                                sortedAt: null,
                                columnGroupShow: "open",
                                pinned: "left"
                            });

                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        }
                    },
                    onRemoveColumn: function(column) {
                        var singleColDef = colDef.find(function(cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            colDef.splice(colDef.indexOf(singleColDef), 1);
                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        } else {
                            console.error('no coldDef', colDef, column);
                        }
                    },
                    getColumnsErrors: function() {
                        return window.grid.behavior.getColumnsErrors();
                    },
                    getFieldsErrorsMessage: function(fields) {
                        if (!fields) {
                            fields = this.getColumnsErrors();
                        }
                        fields = Object.keys(fields);
                        return `The following fields have possible errors: ${fields.join(', ')}. Please review them before saving your data.`;
                    },
                    getMainMenuItems: (params) => [
                        {
                            "name": "Data Type: <span class=\"ag-grid-selected-type \">Text </span>",
                            "childMenu": [
                                {
                                    "name": "<span class=\"capitalized-text\">Text</span>",
                                    "icon": "<i class=\"fa fa-fw fa-check\"></i>"
                                },
                                {
                                    "name": "<span class=\"capitalized-text\">Number</span>",
                                    "icon": "<i class=\"fa fa-fw\"></i>"
                                },
                                {
                                    "name": "<span class=\"capitalized-text\">Date/Time</span>",
                                    "icon": "<i class=\"fa fa-fw\"></i>"
                                },
                                "separator",
                                {
                                    "name": "<span class=\"capitalized-text disabled\">List field: no</span>",
                                    "childMenu": [
                                        {
                                            "name": "Not a list field",
                                            "icon": "<i class=\"fa fa-fw fa-check\"></i>"
                                        },
                                        {
                                            "name": "\n                        <span class=\"split-character\">,</span>\n                        <span class=\"split-character-description\">(comma)</span>\n                        ",
                                            "icon": "<i class=\"fa fa-fw \"></i>"
                                        },
                                        {
                                            "name": "\n                        <span class=\"split-character\">:</span>\n                        <span class=\"split-character-description\">(colon)</span>\n                        ",
                                            "icon": "<i class=\"fa fa-fw \"></i>"
                                        },
                                        {
                                            "name": "\n                        <span class=\"split-character\">;</span>\n                        <span class=\"split-character-description\">(semi-color)</span>\n                        ",
                                            "icon": "<i class=\"fa fa-fw \"></i>"
                                        }
                                    ]
                                }
                            ]
                        },
                        "separator",
                        {
                            "name": "Search Type: <span class=\"ag-grid-selected-type\"><span class=\"hl\">edge</span> search</span>",
                            "childMenu": [
                                {
                                    "name": "off",
                                    "icon": "<i class=\"fa fa-fw\"></i>"
                                },
                                {
                                    "name": "<span class=\"hl\">exact match</span>",
                                    "icon": "<i class=\"fa fa-fw\"></i>"
                                },
                                {
                                    "name": "<span class=\"hl\">edge</span> search",
                                    "icon": "<i class=\"fa fa-fw fa-check\"></i>"
                                },
                                {
                                    "name": "full in<span class=\"hl\">ner</span> search",
                                    "icon": "<i class=\"fa fa-fw\"></i>"
                                }
                            ]
                        },
                        "separator",
                        {
                            "name": "Rename"
                        },
                        {
                            "name": "Remove"
                        }
                    ],
                    getContextMenuItems: (params) => [
                        {
                            "name": "Copy"
                        },
                        {
                            "name": "Copy With Headers"
                        }
                    ]
                };
                window.grid = window.grid || new fin.Hypergrid(div, options);

                function appendData() {
                    // window.grid.api.clearFocusedCell();
                    // window.grid.api.clearRangeSelection();
                    // window.grid.api.destroy();
                    window.grid.api.setColumnDefs(getColDef());
                    window.grid.api.setDatasource({ totalSize: 2000000000, sortModel: [], getRows: (p) => p.successCallback(prepareData(result)) });
                    window.grid.api.sizeColumnsToFit();

                    window.grid.api.attachLinkToDataCell(1, 1, 'https://google.com');
                    window.grid.api.attachLinkToDataCell(1, 2, 'https://google.com');
                    // setTimeout(appendData, 5000);
                }

                appendData();
                // setTimeout(appendData, 100);
            });
        };
    </script>
    <style>
        body * {
            box-sizing: border-box;
        }

        /* for beautiful canvas drawing */

        canvas {
            image-rendering: optimizeSpeed;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor;
        }

        .tooltip {
            position: absolute;
            z-index: 1070;
            display: block;
            font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
            font-size: 12px;
            font-style: normal;
            font-weight: 400;
            line-height: 1.42857143;
            text-align: left;
            text-align: start;
            text-decoration: none;
            text-shadow: none;
            text-transform: none;
            letter-spacing: normal;
            word-break: normal;
            word-spacing: normal;
            word-wrap: normal;
            white-space: normal;
            line-break: auto;
        }
        .tooltip.right {
            padding: 0 5px;
            margin-left: 3px;
        }
        .tooltip.bottom {
            padding: 5px 0;
            margin-top: 3px;
        }
        .tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-color: transparent;
            border-style: solid;
        }
        .tooltip.bottom .tooltip-arrow {
            top: 0;
            left: 50%;
            margin-left: -5px;
            border-width: 0 5px 5px;
            border-bottom-color: #000;
        }
        .tooltip.right .tooltip-arrow {
            top: 50%;
            left: 0;
            margin-top: -5px;
            border-width: 5px 5px 5px 0;
            border-right-color: #000;
        }

        .tooltip-inner {
            max-width: 200px;
            padding: 3px 8px;
            color: #fff;
            text-align: center;
            background-color: #000;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<p> Fin-HyperGrid example using AJAX. <span id="loading">Loading... </span></p>
<div id="json-example" style="position:relative; width:100%; height: 100%"></div>
</body>
</html>
