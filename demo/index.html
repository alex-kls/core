<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script src="build/fin-hypergrid.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <script>
        'use strict';

        var HTTP_STATE_DONE = 4,
            HTTP_STATUS_OK = 200,
            LOCAL_STORAGE_COLUMNS_DEF = 'colDef';

        function get(url, callback) {
            var httpRequest = new XMLHttpRequest();
            httpRequest.open('GET', url, true);
            httpRequest.onreadystatechange = function() {
                if (
                    httpRequest.readyState === HTTP_STATE_DONE &&
                    httpRequest.status === HTTP_STATUS_OK
                ) {
                    callback(JSON.parse(httpRequest.responseText));
                }
            };
            httpRequest.send(null);
        }

        window.onload = function() {
            get('data/datadoc.json', function(result) {
                console.log('result', result);
                var loadingSpan = document.querySelector('span#loading');
                loadingSpan.style.visibility = "hidden";
                var div = document.querySelector('div#json-example');

                function getColDef() {
                    var colDef = localStorage.getItem(LOCAL_STORAGE_COLUMNS_DEF);
                    if (!colDef || colDef.length <= 2) {
                        colDef = "[{\"colId\":\"$$aggregation\",\"headerName\":\"Aggregation: Book.Genre \",\"rawHeaderName\":\"Aggregation: Book.Genre \",\"field\":\"$$aggregation\",\"minWidth\":10,\"maxWidth\":2000,\"minFitWidth\":150,\"suppressMenu\":true,\"suppressMovable\":true,\"cellRenderer\":\"group\",\"cellRendererParams\":{},\"headerTooltip\":\"Aggregation: Book.Genre \",\"groupPadding\":17,\"lastNonGroupChildMinusPadding\":6,\"suppressDefaultTitle\":true,\"sort\":\"asc\",\"sortingOrder\":[\"asc\",\"desc\"]},{\"colId\":\"VALUE_c0\",\"field\":\"VALUE_c0\",\"originalField\":\"VALUE_c0\",\"headerName\":\"Book[ID]\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"VALUE_c1\",\"field\":\"VALUE_c1\",\"originalField\":\"VALUE_c1\",\"headerName\":\"Book.Author\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"VALUE_c2\",\"field\":\"VALUE_c2\",\"originalField\":\"VALUE_c2\",\"headerName\":\"Book.Title\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"width\":529,\"suppressSizeToFit\":true,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"VALUE_c3\",\"field\":\"VALUE_c3\",\"originalField\":\"VALUE_c3\",\"headerName\":\"Book.Genre\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"VALUE_c4\",\"field\":\"VALUE_c4\",\"originalField\":\"VALUE_c4\",\"headerName\":\"Book.Price\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"VALUE_c5\",\"field\":\"VALUE_c5\",\"originalField\":\"VALUE_c5\",\"headerName\":\"Book.Publish date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"VALUE_c6\",\"field\":\"VALUE_c6\",\"originalField\":\"VALUE_c6\",\"headerName\":\"Book.Description\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"left\"},{\"colId\":\"COUNT_c1\",\"field\":\"COUNT_c1\",\"originalField\":\"COUNT_c1\",\"headerName\":\"Book.Author\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"COUNT_c0\",\"field\":\"COUNT_c0\",\"originalField\":\"COUNT_c0\",\"headerName\":\"Book[ID]\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"COUNT_c2\",\"field\":\"COUNT_c2\",\"originalField\":\"COUNT_c2\",\"headerName\":\"Book.Title\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"COUNT_c3\",\"field\":\"COUNT_c3\",\"originalField\":\"COUNT_c3\",\"headerName\":\"Book.Genre\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"COUNT_c4\",\"field\":\"COUNT_c4\",\"originalField\":\"COUNT_c4\",\"headerName\":\"Book.Price\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"SUM_c4\",\"field\":\"SUM_c4\",\"originalField\":\"SUM_c4\",\"headerName\":\"Book.Price\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"AVG_c4\",\"field\":\"AVG_c4\",\"originalField\":\"AVG_c4\",\"headerName\":\"Book.Price\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"MIN_c4\",\"field\":\"MIN_c4\",\"originalField\":\"MIN_c4\",\"headerName\":\"Book.Price\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"MAX_c4\",\"field\":\"MAX_c4\",\"originalField\":\"MAX_c4\",\"headerName\":\"Book.Price\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"COUNT_c6\",\"field\":\"COUNT_c6\",\"originalField\":\"COUNT_c6\",\"headerName\":\"Book.Description\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"},{\"colId\":\"COUNT_c5\",\"field\":\"COUNT_c5\",\"originalField\":\"COUNT_c5\",\"headerName\":\"Book.Publish date\",\"suppressSorting\":false,\"minWidth\":10,\"maxWidth\":2000,\"suppressMenu\":0,\"suppressMovable\":false,\"suppressSizeToFit\":false,\"sort\":null,\"sortedAt\":null,\"columnGroupShow\":\"open\",\"halign\":\"right\"}]";
                    }
                    return JSON.parse(colDef);
                }
                var colDef = getColDef();

                function prepareData(result) {
                    var res = [];
                    result.data.children.forEach(function(c) {
                        var forPush = {};
                        var keys = Object.keys(c.data);

                        keys.forEach(function(d) {
                            // return forPush[d] = c.data[keys[Math.floor(Math.random() * keys.length)]];
                            return forPush[d] = c.data[d];
                        });
                        res.push(forPush);
                    });
                    return res;
                }

                function prepareSchema(result) {
                    var res = [];
                    result.headers.children.forEach(function(h) {
                        res.push({ header: h.key, name: h.key });
                    });
                    return res;
                }

                var options = {
                    schema: prepareSchema(result),
                    data: [],
                    api: {
                        onScrollEndLimitTrigger: 200
                    },
                    onColumnResized: function(column) {
                        console.log('onColumnResized', column);
                        localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));

                        var singleColDef = colDef.find(function(cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            singleColDef.width = column.getWidth();

                        } else {
                            console.error('no coldDef', colDef, column);
                        }
                    },
                    onColumnsMoved: function(columns, toIndex) {
                        console.log('onColumnsMoved', columns, toIndex);
                        columns.reverse().forEach(function(column) {
                            var colDefsLocal = getColDef();
                            var singleColDef = colDefsLocal.find(function(cd) {
                                return cd.colId === column.name;
                            });

                            if (singleColDef) {
                                colDefsLocal.splice(toIndex, 0, colDefsLocal.splice(colDefsLocal.indexOf(singleColDef), 1)[0]);
                                localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDefsLocal));
                            } else {
                                console.error('no coldDef', colDef, column);
                            }
                        });
                    },
                    onUpdateColumnName: function(column, renameTo) {
                        console.log('onUpdateColumnName', column, renameTo);
                        var singleColDef = colDef.find(function (cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            singleColDef.headerName = renameTo;
                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        } else {
                            console.log('column', column);
                            var colDefLength = colDef.length + 1;
                            colDef.push({
                                colId:"c" + colDefLength,
                                field:"c" + colDefLength,
                                originalField:"c" + colDefLength,
                                headerName:renameTo,
                                suppressSorting:false,
                                minWidth:10,
                                maxWidth:2000,
                                suppressMenu:0,
                                suppressMovable:false,
                                suppressSizeToFit:false,
                                sort:null,
                                sortedAt:null,
                                columnGroupShow:"open",
                                pinned:"left"
                            });

                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        }
                    },
                    onRemoveColumn: function(column) {
                        var singleColDef = colDef.find(function (cd) {
                            return cd.colId === column.name;
                        });

                        if (singleColDef) {
                            colDef.splice(colDef.indexOf(singleColDef), 1);
                            localStorage.setItem(LOCAL_STORAGE_COLUMNS_DEF, JSON.stringify(colDef));
                        } else {
                            console.error('no coldDef', colDef, column);
                        }
                    }
                };
                window.grid = window.grid || new fin.Hypergrid(div, options);

                function appendData() {
                    // window.grid.api.clearFocusedCell();
                    // window.grid.api.clearRangeSelection();
                    // window.grid.api.destroy();
                    window.grid.api.setColumnDefs(getColDef());
                    window.grid.api.setRowData(prepareData(result));
                    window.grid.api.sizeColumnsToFit();

                    window.grid.api.attachLinkToDataCell(1, 1, 'https://google.com');
                    window.grid.api.attachLinkToDataCell(1, 2, 'https://google.com');
                }
                appendData();
                // setTimeout(appendData, 100);
            });
        };
    </script>
    <style>
        body * {
            box-sizing: border-box;
        }

        /* for beautiful canvas drawing */

        canvas {
            image-rendering: optimizeSpeed;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor;
        }
    </style>
</head>
<body>
<p> Fin-HyperGrid example using AJAX. <span id="loading">Loading... </span></p>
<div id="json-example" style="position:relative; width:100%; height: 100%"></div>
</body>
</html>
